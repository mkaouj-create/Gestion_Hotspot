
import React, { useEffect, useState } from 'react';
import { Building2, Search, Loader2, ShieldCheck, X, Pencil, Trash2, Save, ShieldAlert, AlertCircle, CheckCircle2, Crown, Check, CalendarPlus, Clock, Banknote } from 'lucide-react';
import { db } from '../services/db';
import { UserRole } from '../types';

const Agencies: React.FC = () => {
  const [tenants, setTenants] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState('');
  const [editingTenant, setEditingTenant] = useState<any | null>(null);
  const [tenantToDelete, setTenantToDelete] = useState<any | null>(null);
  const [tenantToValidate, setTenantToValidate] = useState<any | null>(null);
  const [editName, setEditName] = useState('');
  const [confirmDeleteText, setConfirmDeleteText] = useState('');
  const [isProcessing, setIsProcessing] = useState(false);
  const [toast, setToast] = useState<{ type: 'success' | 'error', message: string } | null>(null);

  useEffect(() => { fetchTenants(); }, []);
  const showToast = (type: 'success' | 'error', message: string) => { setToast({ type, message }); setTimeout(() => setToast(null), 4000); };

  const fetchTenants = async () => {
    try {
      setLoading(true);
      const { data, error } = await db.from('tenants').select('*, users(full_name, role)').order('created_at', { ascending: false });
      if (error) throw error;
      setTenants((data || []).map(t => ({ ...t, manager: t.users?.find((u: any) => u.role === UserRole.GESTIONNAIRE_WIFI_ZONE)?.full_name || 'Inconnu', userCount: t.users?.length || 0 })));
    } catch (err: any) { showToast('error', "Échec du chargement : " + err.message); } finally { setLoading(false); }
  };

  const handlePermanentDelete = async () => {
    if (!tenantToDelete || confirmDeleteText !== 'SUPPRIMER') return;
    setIsProcessing(true);
    try {
      const { error } = await db.rpc('delete_tenant_fully', { target_tenant_id: tenantToDelete.id });
      if (error) throw error;
      setTenants(prev => prev.filter(t => t.id !== tenantToDelete.id)); showToast('success', `L'agence "${tenantToDelete.name}" et ses accès Auth ont été purgés.`); setTenantToDelete(null); setConfirmDeleteText('');
    } catch (err: any) { showToast('error', "Échec suppression : " + (err.message || err.details)); } finally { setIsProcessing(false); }
  };

  const handleValidateAgency = async () => {
    if (!tenantToValidate) return;
    setIsProcessing(true);
    try {
      const now = new Date(); const nextMonth = new Date(now); nextMonth.setDate(now.getDate() + 30);
      const { error } = await db.from('tenants').update({ subscription_status: 'ACTIF', subscription_end_at: nextMonth.toISOString() }).eq('id', tenantToValidate.id);
      if (error) throw error;
      setTenants(prev => prev.map(t => t.id === tenantToValidate.id ? { ...t, subscription_status: 'ACTIF', subscription_end_at: nextMonth.toISOString() } : t));
      showToast('success', `Agence "${tenantToValidate.name}" activée.`); setTenantToValidate(null);
    } catch (err: any) { showToast('error', "Échec validation : " + err.message); } finally { setIsProcessing(false); }
  };

  const handleUpdate = async (e: React.FormEvent) => {
    e.preventDefault(); setIsProcessing(true);
    try {
      const { error } = await db.from('tenants').update({ name: editName }).eq('id', editingTenant.id);
      if (error) throw error;
      setTenants(prev => prev.map(t => t.id === editingTenant.id ? { ...t, name: editName } : t)); setEditingTenant(null); showToast('success', "Agence renommée.");
    } catch (err: any) { showToast('error', err.message); } finally { setIsProcessing(false); }
  };

  const filteredTenants = tenants.filter(t => t.name.toLowerCase().includes(searchTerm.toLowerCase()) || t.manager.toLowerCase().includes(searchTerm.toLowerCase()));
  const simulatedEndDate = new Date(); simulatedEndDate.setDate(simulatedEndDate.getDate() + 30);

  return (
    <div className="space-y-8 font-sans pb-20 animate-in fade-in duration-500 relative">
      {toast && (<div className={`fixed top-6 right-6 z-[100] px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3 animate-in slide-in-from-right-10 border ${toast.type === 'success' ? 'bg-emerald-600 text-white border-emerald-500' : 'bg-red-600 text-white border-red-500'}`}>{toast.type === 'success' ? <CheckCircle2 className="w-5 h-5" /> : <AlertCircle className="w-5 h-5" />}<p className="font-bold text-sm tracking-tight">{toast.message}</p></div>)}
      <header className="flex flex-col md:flex-row md:items-end justify-between gap-6 bg-white p-10 rounded-[3rem] border border-slate-100 shadow-sm relative overflow-hidden"><div className="absolute top-0 right-0 w-64 h-64 bg-red-500 rounded-full blur-[100px] opacity-5 -mr-20 -mt-20"></div><div className="relative z-10"><div className="flex items-center gap-2 text-red-600 mb-3"><ShieldCheck className="w-5 h-5 fill-current" /><span className="text-[11px] font-black uppercase tracking-[0.2em]">SaaS Master Control</span></div><h1 className="text-4xl font-black text-slate-900 tracking-tight">Supervision des Agences</h1><p className="text-slate-400 font-medium mt-1">Gérez le cycle de vie complet des agences partenaires.</p></div><div className="bg-slate-900 text-white p-6 rounded-[2rem] flex items-center gap-4 shadow-xl relative z-10"><div className="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center"><Building2 className="w-6 h-6 text-red-400" /></div><div><p className="text-[10px] font-black uppercase tracking-widest text-slate-400">Total SaaS</p><p className="text-xl font-black">{tenants.length} Agences</p></div></div></header>
      <div className="bg-white rounded-[3rem] border border-slate-100 shadow-sm overflow-hidden min-h-[500px]"><div className="p-8 border-b border-slate-50"><div className="relative max-w-md group"><Search className="absolute left-6 top-1/2 -translate-y-1/2 w-6 h-6 text-slate-300 group-focus-within:text-red-500 transition-colors" /><input type="text" placeholder="Chercher une agence ou un gérant..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full pl-16 pr-6 py-5 rounded-2xl border border-slate-100 bg-slate-50/50 focus:bg-white focus:ring-8 focus:ring-red-50 outline-none font-bold text-slate-700 transition-all" /></div></div><div className="overflow-x-auto"><table className="w-full text-left"><thead><tr className="bg-slate-50/50 text-[10px] font-black text-slate-400 uppercase tracking-widest"><th className="px-10 py-6">IDENTITÉ AGENCE</th><th className="px-10 py-6">GÉRANT MASTER</th><th className="px-10 py-6 text-center">DEVISE</th><th className="px-10 py-6 text-center">STATUT</th><th className="px-10 py-6 text-right">MASTER ACTIONS</th></tr></thead><tbody className="divide-y divide-slate-50">{loading ? (<tr><td colSpan={5} className="p-20 text-center"><Loader2 className="w-12 h-12 animate-spin mx-auto text-red-200" /></td></tr>) : filteredTenants.length === 0 ? (<tr><td colSpan={5} className="p-20 text-center text-slate-300 font-bold uppercase text-xs tracking-widest">Aucune agence trouvée</td></tr>) : filteredTenants.map((tenant) => { const isPending = tenant.subscription_status === 'EN_ATTENTE'; const isSuspended = tenant.subscription_status === 'SUSPENDU' || (tenant.subscription_end_at && new Date(tenant.subscription_end_at) < new Date()); return (<tr key={tenant.id} className="hover:bg-slate-50/50 group transition-all"><td className="px-10 py-8"><div className="flex items-center gap-4"><div className={`w-12 h-12 rounded-2xl flex items-center justify-center shadow-sm transition-all ${isPending ? 'bg-orange-50 text-orange-500 animate-pulse' : isSuspended ? 'bg-red-50 text-red-300' : 'bg-slate-100 text-slate-400 group-hover:bg-red-600 group-hover:text-white'}`}>{isPending ? <Clock className="w-6 h-6" /> : <Building2 className="w-6 h-6" />}</div><div><p className="font-black text-slate-900 text-lg tracking-tight">{tenant.name}</p><p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{tenant.id.split('-')[0]}</p></div></div></td><td className="px-10 py-8"><div className="flex items-center gap-3"><div className="w-9 h-9 rounded-xl bg-indigo-50 flex items-center justify-center text-indigo-500 shadow-inner"><Crown className="w-4 h-4" /></div><span className="text-sm font-black text-slate-700">{tenant.manager}</span></div></td><td className="px-10 py-8 text-center"><div className="inline-flex items-center gap-1.5 bg-slate-50 px-3 py-1.5 rounded-xl border border-slate-100"><Banknote className="w-3.5 h-3.5 text-slate-400" /><span className="text-xs font-black text-slate-700">{tenant.currency || 'GNF'}</span></div></td><td className="px-10 py-8 text-center"><div className={`inline-flex items-center gap-2 px-4 py-2 rounded-full text-[9px] font-black uppercase tracking-widest border shadow-sm ${isPending ? 'bg-orange-50 text-orange-600 border-orange-100' : isSuspended ? 'bg-red-50 text-red-600 border-red-100' : 'bg-emerald-50 text-emerald-600 border-emerald-100'}`}><div className={`w-1.5 h-1.5 rounded-full ${isPending ? 'bg-orange-500' : isSuspended ? 'bg-red-500 animate-pulse' : 'bg-emerald-500'}`}></div>{isPending ? 'EN ATTENTE' : isSuspended ? 'Suspendu / Expiré' : 'Service Actif'}</div></td><td className="px-10 py-8 text-right"><div className="flex justify-end gap-3 opacity-80 group-hover:opacity-100 transition-opacity">{isPending && (<button onClick={() => setTenantToValidate(tenant)} className="p-3 bg-emerald-600 text-white rounded-xl shadow-lg hover:bg-emerald-500 transition-all flex items-center gap-2"><Check className="w-4 h-4" /> <span className="text-[10px] font-black uppercase">Valider</span></button>)}<button onClick={() => { setEditingTenant(tenant); setEditName(tenant.name); }} className="p-3 text-slate-400 hover:text-slate-900 hover:bg-white rounded-xl shadow-sm transition-all border border-transparent hover:border-slate-200"><Pencil className="w-4 h-4" /></button><button onClick={() => setTenantToDelete(tenant)} className="p-3 text-slate-400 hover:text-red-600 hover:bg-white rounded-xl shadow-sm transition-all border border-transparent hover:border-red-100"><Trash2 className="w-4 h-4" /></button></div></td></tr>); })}</tbody></table></div></div>
      {editingTenant && (<div className="fixed inset-0 z-[60] flex items-center justify-center p-4 animate-in fade-in"><div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onClick={() => !isProcessing && setEditingTenant(null)} /><form onSubmit={handleUpdate} className="bg-white w-full max-w-sm rounded-[3rem] p-12 relative z-10 animate-in zoom-in-95 border border-slate-100 shadow-2xl"><button type="button" onClick={() => setEditingTenant(null)} className="absolute top-8 right-8 text-slate-300 hover:text-slate-900 transition-colors"><X className="w-6 h-6" /></button><h3 className="text-2xl font-black mb-2 text-slate-900 tracking-tight uppercase">Master Edit</h3><p className="text-xs text-slate-400 font-medium mb-10 uppercase tracking-widest leading-relaxed">Modification administrative du nom de l'agence.</p><div className="space-y-2 mb-10"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Identifiant Agence</label><input type="text" value={editName} onChange={e => setEditName(e.target.value)} className="w-full p-6 bg-slate-50 border border-slate-100 rounded-2xl font-black text-slate-900 outline-none focus:ring-8 focus:ring-slate-100 transition-all text-lg" required /></div><button type="submit" disabled={isProcessing} className="w-full py-6 bg-slate-900 hover:bg-black text-white rounded-2xl font-black uppercase text-xs tracking-[0.2em] flex items-center justify-center gap-3 shadow-xl transition-all">{isProcessing ? <Loader2 className="w-5 h-5 animate-spin" /> : <><Save className="w-4 h-4" /> VALIDER LES CHANGEMENTS</>}</button></form></div>)}
      {tenantToValidate && (<div className="fixed inset-0 z-[70] flex items-center justify-center p-4"><div className="absolute inset-0 bg-slate-900/80 backdrop-blur-md animate-in fade-in" onClick={() => !isProcessing && setTenantToValidate(null)} /><div className="bg-white w-full max-w-md rounded-[4rem] shadow-2xl relative z-10 overflow-hidden animate-in zoom-in-95 border border-emerald-100"><div className="p-12 text-center"><div className="w-24 h-24 bg-emerald-50 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-8 shadow-inner"><CheckCircle2 className="w-12 h-12" /></div><h3 className="text-3xl font-black text-slate-900 mb-4 uppercase tracking-tight">Valider l'Agence ?</h3><p className="text-slate-500 font-medium text-sm leading-relaxed mb-6 px-4">Vous allez activer le compte de <strong className="text-emerald-600 font-black">"{tenantToValidate.name}"</strong>.</p><div className="bg-emerald-50 p-6 rounded-[2rem] mb-8 border border-emerald-100 mx-4"><div className="flex items-center gap-3 justify-center mb-2"><CalendarPlus className="w-5 h-5 text-emerald-600" /><span className="text-[10px] font-black text-emerald-700 uppercase tracking-widest">OFFRE DE BIENVENUE</span></div><p className="text-xl font-black text-slate-900">30 Jours Gratuits</p><p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Validité : {simulatedEndDate.toLocaleDateString('fr-FR')}</p></div><div className="space-y-3 px-4"><button onClick={handleValidateAgency} disabled={isProcessing} className="w-full py-6 bg-emerald-600 hover:bg-emerald-700 text-white rounded-[2rem] font-black text-xs tracking-[0.2em] uppercase shadow-2xl shadow-emerald-200 transition-all transform active:scale-95 flex items-center justify-center gap-3">{isProcessing ? <Loader2 className="w-5 h-5 animate-spin" /> : "ACTIVER + 30 JOURS"}</button><button onClick={() => setTenantToValidate(null)} disabled={isProcessing} className="w-full py-5 bg-white text-slate-400 hover:text-slate-900 rounded-2xl font-black text-xs tracking-widest uppercase transition-colors">ANNULER</button></div></div></div></div>)}
      {tenantToDelete && (<div className="fixed inset-0 z-[70] flex items-center justify-center p-4"><div className="absolute inset-0 bg-red-950/90 backdrop-blur-md animate-in fade-in" onClick={() => !isProcessing && setTenantToDelete(null)} /><div className="bg-white w-full max-w-md rounded-[4rem] shadow-2xl relative z-10 overflow-hidden animate-in zoom-in-95 border-t-8 border-red-600"><div className="p-12 text-center"><div className="w-24 h-24 bg-red-50 text-red-600 rounded-full flex items-center justify-center mx-auto mb-8 shadow-inner animate-pulse"><ShieldAlert className="w-12 h-12" /></div><h3 className="text-3xl font-black text-slate-900 mb-4 uppercase tracking-tight">Suppression SaaS</h3><p className="text-slate-500 font-medium text-sm leading-relaxed mb-10 px-4">Attention ! Supprimer <strong className="text-red-600 font-black">"{tenantToDelete.name}"</strong> déclenche une purge automatique de TOUT son écosystème.</p><div className="space-y-4 px-4"><div className="space-y-2 text-left"><label className="text-[11px] font-black text-red-600 uppercase tracking-widest ml-1 text-center block mb-2">Taper "SUPPRIMER" pour purger</label><input type="text" placeholder="..." value={confirmDeleteText} onChange={e => setConfirmDeleteText(e.target.value)} className="w-full p-6 bg-red-50 border-2 border-red-100 rounded-3xl font-black text-red-900 text-center uppercase tracking-[0.3em] outline-none focus:ring-8 focus:ring-red-200 transition-all placeholder:text-red-200" /></div><button onClick={handlePermanentDelete} disabled={isProcessing || confirmDeleteText !== 'SUPPRIMER'} className={`w-full py-6 rounded-[2rem] font-black text-xs tracking-[0.2em] uppercase shadow-2xl transition-all transform active:scale-95 ${confirmDeleteText === 'SUPPRIMER' ? 'bg-red-600 hover:bg-red-700 text-white shadow-red-200' : 'bg-slate-100 text-slate-300 cursor-not-allowed border border-slate-200 shadow-none'}`}>{isProcessing ? <Loader2 className="w-5 h-5 animate-spin" /> : "DÉTRUIRE TOUTES LES DONNÉES"}</button><button onClick={() => { setTenantToDelete(null); setConfirmDeleteText(''); }} disabled={isProcessing} className="w-full py-5 bg-white text-slate-400 hover:text-slate-900 rounded-2xl font-black text-xs tracking-widest uppercase transition-colors">ANNULER L'ACTION</button></div></div></div></div>)}
    </div>
  );
};
export default Agencies;
